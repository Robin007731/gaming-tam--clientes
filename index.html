<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | OFICIAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #030508; --card: #0d1117; --success: #39FF14; --error: #ff3131; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; overflow: hidden; }

        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; padding-bottom: 80px; overflow-y: auto; }
        .active { display: flex; }

        /* Estilos de Autenticaci칩n */
        .auth-card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #1a1f26; width: 100%; max-width: 380px; text-align: center; margin: auto; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #222; color: #fff; margin-bottom: 10px; border-radius: 8px; font-family: 'Rajdhani'; }
        .btn { width: 100%; padding: 15px; background: var(--neon); border: none; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 8px; color: #000; transition: 0.3s; }
        .btn:disabled { background: #222; color: #555; cursor: not-allowed; }

        /* Tarjetas de Torneo */
        .card-item { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #1a1f26; position: relative; }
        .bracket-link { color: #ffd700; text-decoration: none; font-size: 0.7rem; display: block; margin-top: 10px; font-family: 'Orbitron'; border: 1px dashed #ffd700; padding: 5px; text-align: center; border-radius: 5px; }

        /* Chat System */
        .chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; border-radius: 8px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; font-size: 0.9rem; word-wrap: break-word; }
        .msg-me { background: var(--neon); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-others { background: #1a1f26; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-nick { font-size: 0.6rem; font-weight: bold; display: block; margin-bottom: 2px; opacity: 0.7; }

        /* Navbar Inferior */
        .navbar { position: fixed; bottom: 0; width: 100%; background: rgba(13,17,23,0.98); display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid var(--neon); z-index: 1000; }
        .nav-btn { color: #555; cursor: pointer; font-size: 0.6rem; font-family: 'Orbitron'; text-align: center; }
        .nav-btn.active { color: var(--neon); text-shadow: 0 0 10px var(--neon); }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen active" style="justify-content: center;">
        <div class="auth-card">
            <h1 id="auth-title" style="font-family:'Orbitron'; color:var(--neon); margin-bottom:20px; letter-spacing: 2px;">ZONA_GAMER</h1>
            <div id="auth-inputs">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="pass" placeholder="Contrase침a">
                <button class="btn" onclick="handleAuth()">INGRESAR AL SISTEMA</button>
            </div>
            <p id="auth-toggle" onclick="toggleReg()" style="font-size:0.7rem; margin-top:20px; cursor:pointer; color:#666;">
                쮼res nuevo? <span style="color:var(--neon)">Crea tu cuenta gamer</span>
            </p>
        </div>
    </div>

    <div id="scr-tournaments" class="screen">
        <h2 style="font-family:'Orbitron'; border-bottom: 1px solid #1a1f26; padding-bottom: 10px; color: var(--neon);">TORNEOS_ZONA</h2>
        <div id="tournament-list"></div>
    </div>

    <div id="scr-chat" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="chat-title" style="font-family:'Orbitron'; margin:0;">CHAT_GLOBAL</h2>
            <button id="btn-back-global" onclick="setChatTarget('global')" style="display:none; background:none; border:1px solid var(--neon); color:var(--neon); font-size:0.6rem; padding:4px 8px; border-radius:4px; font-family:'Orbitron'; cursor:pointer;">VOLVER AL GLOBAL</button>
        </div>
        <div class="chat-box" id="chat-msgs" style="margin-top:20px;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="chat-input" placeholder="Escribe mensaje..." style="margin:0;" onkeypress="if(event.key === 'Enter') sendMsg()">
            <button onclick="sendMsg()" style="background:var(--neon); border:none; padding:0 20px; border-radius:8px; font-weight:bold; cursor:pointer;">></button>
        </div>
    </div>

    <div id="scr-social" class="screen">
        <div style="text-align:center; background:var(--card); padding:20px; border-radius:20px; margin-bottom:20px; border: 1px solid var(--neon);">
            <h2 id="my-nick" style="font-family:'Orbitron'; color:var(--neon); margin:0;">...</h2>
            <div id="my-xp" style="color:var(--success); font-weight:bold; letter-spacing: 1px;">0 XP</div>
            <button onclick="auth.signOut()" style="background:none; border:none; color:var(--error); font-size:0.7rem; margin-top:10px; cursor:pointer; font-family:'Orbitron'; opacity: 0.6;">[ DESCONECTAR ]</button>
        </div>
        <h4 style="font-family:'Orbitron'; font-size:0.7rem; color:#444; margin-bottom: 10px;">COMUNIDAD ONLINE</h4>
        <div id="users-list"></div>
    </div>

    <nav class="navbar" id="app-nav" style="display:none;">
        <div class="nav-btn active" id="btn-nav-tournaments" onclick="nav('scr-tournaments')">TORNEOS</div>
        <div class="nav-btn" id="btn-nav-chat" onclick="nav('scr-chat')">CHAT</div>
        <div class="nav-btn" id="btn-nav-social" onclick="nav('scr-social')">SOCIAL</div>
    </nav>

    <script>
        // CONFIGURACI칍N FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let isRegistering = false;
        let userData = null;
        let chatTarget = "global";
        let chatUnsubscribe = null;

        // NAVEGACI칍N
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btnId = 'btn-nav-' + id.replace('scr-', '');
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            
            if(id === 'scr-chat') {
                setTimeout(loadMessages, 100);
            }
        }

        function toggleReg() {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "NUEVO_GAMER" : "ZONA_GAMER";
            document.getElementById('auth-toggle').innerHTML = isRegistering ? 
                "쯏a eres miembro? <span style='color:var(--neon)'>Inicia Sesi칩n</span>" : 
                "쮼res nuevo? <span style='color:var(--neon)'>Crea tu cuenta gamer</span>";
        }

        // AUTENTICACI칍N
        window.handleAuth = () => {
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('pass').value;
            if(!email || !pass) return alert("Completa los datos de acceso");

            if(isRegistering) {
                const nick = prompt("Ingresa tu GamerTag (Nick):");
                if(!nick) return;
                auth.createUserWithEmailAndPassword(email, pass).then(res => {
                    return db.collection("usuarios").doc(res.user.uid).set({ 
                        nick: nick, 
                        puntos: 0, 
                        email: email,
                        id: res.user.uid 
                    });
                }).catch(e => alert("Error: " + e.message));
            } else {
                auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Datos incorrectos o usuario no existe"));
            }
        };

        // OBSERVADOR DE ESTADO
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('scr-auth').classList.remove('active');
                document.getElementById('app-nav').style.display = 'flex';
                nav('scr-tournaments');

                // Cargar datos usuario
                db.collection("usuarios").doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        document.getElementById('my-nick').innerText = userData.nick.toUpperCase();
                        document.getElementById('my-xp').innerText = (userData.puntos || 0) + " XP";
                    } else if (!isRegistering) { 
                        auth.signOut(); 
                    }
                });

                // Cargar lista de usuarios (Social)
                db.collection("usuarios").limit(30).onSnapshot(snap => {
                    const box = document.getElementById('users-list');
                    box.innerHTML = "";
                    snap.forEach(doc => {
                        if(doc.id !== user.uid) {
                            box.innerHTML += `
                                <div class="card-item" onclick="setChatTarget('${doc.id}', '${doc.data().nick}')" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                                    <span>游릭 ${doc.data().nick}</span>
                                    <span style="font-size:0.6rem; color:var(--neon)">CHAT PRIVADO ></span>
                                </div>`;
                        }
                    });
                });

                // Cargar Torneos
                db.collection("torneos").onSnapshot(snap => {
                    const box = document.getElementById('tournament-list');
                    box.innerHTML = "";
                    snap.forEach(doc => {
                        const t = doc.data();
                        const isJoined = t.jugadores && t.jugadores.includes(user.uid);
                        box.innerHTML += `
                            <div class="card-item">
                                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--success); font-family:'Orbitron';">
                                    <span>TORNEO_ACTIVO</span> <span>${t.inscritos_count || 0}/${t.capacidad} JUGADORES</span>
                                </div>
                                <h3 style="font-family:'Orbitron'; margin:10px 0; color:var(--neon)">${t.nombre}</h3>
                                <p style="font-size:0.8rem; color:#777; margin-bottom:10px;">${t.desc}</p>
                                ${t.bracket_url ? `<a href="${t.bracket_url}" target="_blank" class="bracket-link">游늵 VER ENFRENTAMIENTOS (BRACKETS)</a>` : ''}
                                <button class="btn" style="margin-top:10px; background:${isJoined ? '#111' : 'var(--neon)'}; color:${isJoined ? '#444' : '#000'}" 
                                        onclick="joinT('${doc.id}', ${isJoined})" ${isJoined ? 'disabled' : ''}>
                                    ${isJoined ? 'EST츼S INSCRITO' : 'UNIRSE AL TORNEO'}
                                </button>
                            </div>`;
                    });
                });

            } else {
                document.getElementById('app-nav').style.display = 'none';
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-auth').classList.add('active');
            }
        });

        // CHAT LOGIC
        function setChatTarget(target, nick = "GLOBAL") {
            chatTarget = target;
            document.getElementById('chat-title').innerText = target === 'global' ? "CHAT_GLOBAL" : "MENSAJE: " + nick;
            document.getElementById('btn-back-global').style.display = target === 'global' ? 'none' : 'block';
            nav('scr-chat');
        }

        function loadMessages() {
            if(chatUnsubscribe) chatUnsubscribe(); // Cancelar suscripci칩n anterior
            
            const user = auth.currentUser;
            if(!user) return;
            
            let query = db.collection("chats");
            if(chatTarget === "global") {
                query = query.where("tipo", "==", "global").orderBy("timestamp", "asc");
            } else {
                const chatId = [user.uid, chatTarget].sort().join("_");
                query = query.where("chatId", "==", chatId).orderBy("timestamp", "asc");
            }

            chatUnsubscribe = query.limitToLast(30).onSnapshot(snap => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === user.uid;
                    box.innerHTML += `
                        <div class="msg ${isMe ? 'msg-me' : 'msg-others'}">
                            <span class="msg-nick">${m.senderNick}</span>
                            ${m.texto}
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            }, error => {
                console.error("Error cargando mensajes: ", error);
                if(error.code === 'failed-precondition') {
                    console.warn("Necesitas crear un 칤ndice en Firestore para que el chat funcione.");
                }
            });
        }

        window.sendMsg = () => {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !userData) return;
            
            const user = auth.currentUser;
            const data = {
                texto: txt, 
                senderId: user.uid, 
                senderNick: userData.nick,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(chatTarget === "global") {
                data.tipo = "global";
            } else {
                data.tipo = "privado";
                data.chatId = [user.uid, chatTarget].sort().join("_");
            }

            db.collection("chats").add(data);
            input.value = "";
        };

        // UNIRSE A TORNEO
        window.joinT = (id, joined) => {
            if(joined) return;
            const user = auth.currentUser;
            db.collection("torneos").doc(id).update({
                jugadores: firebase.firestore.FieldValue.arrayUnion(user.uid),
                inscritos_count: firebase.firestore.FieldValue.increment(1)
            }).then(() => alert("춰Inscripci칩n confirmada en ZONA GAMER!"))
              .catch(e => alert("Error al inscribirse: " + e.message));
        };

    </script>
</body>
</html>
