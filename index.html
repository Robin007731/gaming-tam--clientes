<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOURNAMENT MASTER | GAMER NET</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --neon: #00f2ff; --bg: #030508; --card: #0d1117; --success: #39FF14; --gold: #ffd700; --msg-bg: #1a1f26; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; overflow: hidden; }
        
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; padding-bottom: 80px; overflow-y: auto; }
        .active { display: flex; }

        /* Torneos */
        .tournament-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #1a1f26; border-left: 5px solid var(--neon); }
        .status-badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 4px; background: #000; color: var(--success); border: 1px solid var(--success); }
        .bracket-link { color: var(--gold); text-decoration: none; font-family: 'Orbitron'; font-size: 0.7rem; display: block; margin-top: 10px; }

        /* Chat UI */
        #chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .message { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 0.9rem; position: relative; }
        .msg-others { background: var(--msg-bg); align-self: flex-start; }
        .msg-me { background: var(--neon); color: #000; align-self: flex-end; }
        .msg-nick { font-size: 0.6rem; opacity: 0.7; display: block; margin-bottom: 2px; }
        .chat-input-area { display: flex; gap: 10px; padding: 10px 0; }

        /* Inputs & Botones */
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #222; color: #fff; border-radius: 8px; }
        .btn { width: 100%; padding: 15px; background: var(--neon); border: none; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 8px; }
        
        /* Navbar */
        .navbar { position: fixed; bottom: 0; width: 100%; background: rgba(13,17,23,0.95); display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid var(--neon); z-index: 100; }
        .nav-item { color: #555; cursor: pointer; font-size: 0.6rem; font-family: 'Orbitron'; text-align: center; }
        .nav-item.active { color: var(--neon); }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen active" style="justify-content: center; align-items: center;">
        <div style="width:100%; max-width:350px; text-align:center;">
            <h1 style="font-family:'Orbitron'; color:var(--neon)">GAMER_LOGIN</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn" onclick="login()">INGRESAR</button>
            <p onclick="register()" style="font-size:0.7rem; margin-top:20px; cursor:pointer; color:#666;">Â¿Nuevo? RegÃ­strate aquÃ­</p>
        </div>
    </div>

    <div id="scr-list" class="screen">
        <h2 style="font-family:'Orbitron'; color:var(--neon)">TORNEOS ACTIVOS</h2>
        <div id="tournaments-container"></div>
    </div>

    <div id="scr-chat" class="screen">
        <h2 style="font-family:'Orbitron'; color:var(--neon)" id="chat-title">CHAT GLOBAL</h2>
        <div id="chat-container">
            <div class="chat-messages" id="chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" placeholder="Escribe un mensaje...">
                <button onclick="sendMsg()" style="background:var(--neon); border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">></button>
            </div>
            <button onclick="resetToGlobal()" id="back-global" style="display:none; font-size:0.6rem; color:var(--neon); background:none; border:none; cursor:pointer;">Volver al Global</button>
        </div>
    </div>

    <div id="scr-profile" class="screen">
        <h2 style="font-family:'Orbitron'; text-align:center">COMUNIDAD</h2>
        <div id="user-info-box" style="background:var(--card); padding:15px; border-radius:15px; margin-bottom:20px; text-align:center;">
            <h3 id="p-nick" style="color:var(--neon); margin:0">---</h3>
            <p id="p-xp" style="font-size:0.8rem">0 XP</p>
        </div>
        <h4 style="font-family:'Orbitron'; font-size:0.7rem; color:#444">JUGADORES CONECTADOS (Toca para chat privado)</h4>
        <div id="players-list"></div>
        <button class="btn" style="background:#ff3131; color:#fff; margin-top:20px;" onclick="auth.signOut()">SALIR</button>
    </div>

    <nav class="navbar" id="main-nav" style="display:none">
        <div class="nav-item active" onclick="nav('scr-list')">TORNEOS</div>
        <div class="nav-item" onclick="nav('scr-chat')">CHAT</div>
        <div class="nav-item" onclick="nav('scr-profile')">SOCIAL</div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentNick = "";
        let chatTarget = "global"; // Controla si es global o UID del destinatario

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        window.login = () => {
            const e = document.getElementById('email').value.trim();
            const p = document.getElementById('pass').value;
            auth.signInWithEmailAndPassword(e, p);
        };

        window.register = () => {
            const e = document.getElementById('email').value.trim();
            const p = document.getElementById('pass').value;
            const nick = prompt("Tu Gamer Tag:");
            if(!nick) return;
            auth.createUserWithEmailAndPassword(e, p).then(res => {
                db.collection("usuarios").doc(res.user.uid).set({ nick: nick, puntos: 0, email: e });
            });
        };

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('scr-auth').classList.remove('active');
                document.getElementById('main-nav').style.display = 'flex';
                nav('scr-list');

                // Datos de usuario
                db.collection("usuarios").doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        currentNick = doc.data().nick;
                        document.getElementById('p-nick').innerText = currentNick;
                        document.getElementById('p-xp').innerText = (doc.data().puntos || 0) + " XP";
                    }
                });

                // Lista de Jugadores para Chat Privado
                db.collection("usuarios").limit(20).onSnapshot(snap => {
                    const list = document.getElementById('players-list');
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        if(doc.id !== user.uid) {
                            list.innerHTML += `<div onclick="startPrivateChat('${doc.id}', '${doc.data().nick}')" style="background:var(--card); padding:10px; border-radius:8px; margin-bottom:5px; cursor:pointer; font-size:0.8rem;">ðŸŸ¢ ${doc.data().nick}</div>`;
                        }
                    });
                });

                // Torneos
                db.collection("torneos").onSnapshot(snap => {
                    const cont = document.getElementById('tournaments-container');
                    cont.innerHTML = "";
                    snap.forEach(doc => {
                        const t = doc.data();
                        const isJoined = t.jugadores && t.jugadores.includes(user.uid);
                        cont.innerHTML += `<div class="tournament-card">
                            <span class="status-badge">ACTIVO</span>
                            <h3>${t.nombre}</h3>
                            <button class="btn" style="background:${isJoined ? '#222' : 'var(--neon)'}" onclick="joinT('${doc.id}', ${isJoined})">${isJoined ? 'INSCRITO' : 'UNIRSE'}</button>
                        </div>`;
                    });
                });

                // Escuchar Mensajes (Carga dinÃ¡mica segÃºn chatTarget)
                loadMessages();

            } else {
                document.getElementById('main-nav').style.display = 'none';
                nav('scr-auth');
            }
        });

        // --- LÃ“GICA DE CHAT ---
        window.loadMessages = () => {
            const user = auth.currentUser;
            if(!user) return;

            let query = db.collection("chats");
            
            if(chatTarget === "global") {
                query = query.where("tipo", "==", "global");
                document.getElementById('chat-title').innerText = "CHAT GLOBAL";
                document.getElementById('back-global').style.display = "none";
            } else {
                // Chat privado: Mensajes donde yo envÃ­o o recibo del target
                const chatId = [user.uid, chatTarget].sort().join("_");
                query = query.where("chatId", "==", chatId);
                document.getElementById('back-global').style.display = "block";
            }

            query.orderBy("timestamp", "asc").limitToLast(30).onSnapshot(snap => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === user.uid;
                    box.innerHTML += `
                        <div class="message ${isMe ? 'msg-me' : 'msg-others'}">
                            <span class="msg-nick">${m.senderNick}</span>
                            ${m.texto}
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            const texto = input.value.trim();
            if(!texto) return;

            const user = auth.currentUser;
            const msgData = {
                texto: texto,
                senderId: user.uid,
                senderNick: currentNick,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(chatTarget === "global") {
                msgData.tipo = "global";
            } else {
                msgData.tipo = "privado";
                msgData.chatId = [user.uid, chatTarget].sort().join("_");
                msgData.recipienteId = chatTarget;
            }

            db.collection("chats").add(msgData);
            input.value = "";
        };

        window.startPrivateChat = (uid, nick) => {
            chatTarget = uid;
            document.getElementById('chat-title').innerText = "CHAT: " + nick;
            nav('scr-chat');
            loadMessages();
        };

        window.resetToGlobal = () => {
            chatTarget = "global";
            loadMessages();
        };

        window.joinT = (id, joined) => {
            if(joined) return;
            db.collection("torneos").doc(id).update({
                jugadores: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid),
                inscritos_count: firebase.firestore.FieldValue.increment(1)
            });
        };
    </script>
</body>
</html>
